
// Every override in here is a candidate for a change made to the original scss file

// NOTE: removed blockquote customization from quire-page.scss

// Create SASS variable for root path because there's no easy way to automate this
// TODO: how to get publication url from publication.yaml to here?
// Can we work with environment variables in SASS/11ty?
$root_path: "/";
//$root_path: "/mayer-2023/"; // Github pages path only

/* Cover page
 * TODO: Title responsiveness
 ************************************************************************/
.quire-cover__hero {
  background: $content-background-color;
  min-height: unset !important; // TODO: fix base styles to get rid of this nonsense
  position: relative;

  .quire-cover__overlay {
    background-color: $off-white;
    background-image: url("#{$root_path}_assets/images/cover-800.jpg");
    background-position: center top;
    background-size: contain;
    height: calc(100vw / 1.569506726457399); // based on image aspect ratio
    min-height: unset;
    position: unset;

    @media screen and (min-width: 48rem) {
      background-image: url("#{$root_path}_assets/images/cover-1400.jpg");
    }
    @media screen and (min-width: 72rem) {
      background-image: url("#{$root_path}_assets/images/cover-1920.jpg");
      height: calc(100vw / 2.094972067039106);
    }
    @media screen and (min-width: 120rem) {
      background-image: url("#{$root_path}_assets/images/cover-3000.jpg");
    }
  }

  .quire-cover__hero-body {
    padding-top: 1.25rem;
    padding-bottom: 2rem;
    width: 100%;

    @media screen and (min-width: 58rem) {
      width:35%;
      position:absolute;
      bottom:29%;
      left:1rem;

      svg {
        path#a, path#c {
          fill: #fff;
        }
        path#a {
          filter: url(#b);
        }
        path#c {
          filter: url(#d);
        }
      }
    }

    @media screen and (min-width: 72rem) {
      width: 40%;
      bottom: 27%;
      left:2rem;
    }

    .container {
      background:none;
      color: $content-text-color;
      margin: 0 $gap;
      //padding: 0 1.5rem;
      position: unset;
      display:block;
      text-align: center;
      width:100%;

      @media screen and (min-width: 58rem) {
        color: $white;
      }

      .publication-logo {
        width: 100%;
        margin: 1rem 0 .5rem;
        max-width: 48rem;
      }

      // TODO: go into base styles and remove all nested text color declarations
      h1 {
        color: inherit;
        font-size: 1.75rem;
        line-height: 1.4;
        margin: 0 0 .625em;

        .subtitle {
          color: inherit;
          font-size: 1.375rem;
          line-height: 1.45;
          margin-top: .5em;
        }
      }
      .reading-line {
        color: inherit;
      }
      .contributor {
        color: inherit;
        font-family: $typeface-besley; // TODO: make sure this is consistent for contribs, whatever it is
        font-size: 1rem;
        font-weight: 600;
        line-height: 1.4;
        margin-top:0;

        @media screen and (min-width: 58rem) {
          font-size: 0.875rem;
          text-shadow:.0875em 0.0875em 0.2em rgba(0,0,0,0.7);
        }

        @media screen and (min-width: 67rem) {
          font-size: 1rem;
        }

        @media screen and (min-width: 74rem) {
          font-size: 1.25rem;
        }

        @media screen and (min-width: 90rem) {
          font-size: 1.5rem;
        }
      }

      @media screen and (min-width: 48rem) {
        margin: 0 auto;
        padding: 0;
      }

    }
  }
}

// TODO: remove the markup from the template if they like this being gone
.quire-cover__more {
  display: none;
}

.quire-cover {
  .quire-page__content {
    .container {
      &.is-fluid {
        .content {
          margin-top: 1em; // TODO: Fix base styles here
          padding-top: 1em !important; // TODO: Fix base styles here, too
        }
      }
    }
  }

  // TODO: consider making this global.
  .quire-contents-buttons {
    padding-top: 0;
  }
}

/* ToC page
 * Also made changes to _includes/components/table-of-contents/item/list.js
 * Original markup needed to change
 * Overly broad * selector commented out in quire-contents-list.scss as well
 ************************************************************************/
.quire-contents {
  .quire-page__content {
    .container {
      max-width:38em;
    }
  }
}

.quire-contents-list {
  &.list {
    font-family: $quire-navigation-font;

    .table-of-contents {
      .table-of-contents-list {
        a {
          .contents-page-title {
            font-size: 1.125em;
            font-weight: 600;
          }
          .contributor {
            color: $content-text-color;
            display: block;
            font-style: normal;
      
            &::before {
              content: "by";
              display: inline-block;
              margin: 0 .25em 0 1em;
            }
          }

          &:hover {
            .contents-page-title {
              text-decoration: underline;
            }
          }
        }
      }
    }
  }
}

/*========================================================================
 * END of Table of Contents page customizations
 */


/*------------------------------------------------------------------------
 * Navbar customizations
 * Removed overly broad * selector in quire-navbar.scss
 -----------------------------------------------------------------------*/
.quire-navbar {
  text-shadow:0 0.08333em 0.16667em rgba(0,0,0,0.3);

  .quire-navbar-controls {
    .quire-navbar-button {
      text-shadow:0 0.08333em 0.16667em rgba(0,0,0,0.3);
      color: inherit;

      &:hover {
        color: $quire-navbar-hover-text-color;
      }
    }
  }
  .quire-navbar-page-controls {
    &__item{
      &.quire-previous-page {
        padding-right: 1rem;
      }
      &.quire-next-page {
        padding-left: 1rem;
        position: relative;

        a {
          &::before {
            color: $white;
            content: '|';
            position: absolute;
            left:-.125rem;
            z-index: 10;
          }
        
          &:hover {
            &::before {
              color: $white;
            }
          }
        }
      }
    }
  }
}

/*========================================================================
 * END of Navbar customizations
 =======================================================================*/

/*------------------------------------------------------------------------
 * Menu customizations
 -----------------------------------------------------------------------*/
.menu {
  font-size: 1.25rem;
  line-height: 1.4;
  text-shadow:0 0.08333em 0.16667em rgba(0,0,0,0.3);

  .quire-menu__header__contributors {
    font-family: $typeface-besley;
    font-size: .75em;
    font-style: normal;
    margin-top: 1em;
  }

  .quire-menu__list {
    .page-item {
      line-height: 1.4;
      
    }
  }
}


/*------------------------------------------------------------------------
 * Page customizations
 -----------------------------------------------------------------------*/
// Quire's (and Bulma's) misunderstanding of CSS specificity strikes again.
// Consequently, this selector is wildly overdefined now.
// The more time I spend in Quire, the more I want to forcibly strip out
// all of the CSS (especially Bulma) and start over.
.quire-page .quire-page__content .container.is-fluid .content {
  .dam-credit-line {
    font-family: $quire-footnotes-font;
    font-size: 1.125rem;
    line-height: $quire-backmatter-line-height;

    &.page-end {
      margin-top: 2rem;
    }
  }
}
.quire-essay {
  .quire-page {
    &__header {
      &.hero {
        background: $main-aqua;
        text-shadow:0 0.08333em 0.16667em rgba(0,0,0,0.2);

        .hero-body {
          color: $off-white;

          .quire-page__header__title {
            color: inherit;
            max-width: 54ch;
            margin: 0 auto;
          }

          .quire-page__header__contributor {
            font-size: px-to-rem(24px);
            font-style: normal;
            font-weight: 500;
          }
        }
      }
    }
  }
}

.quire-page__content {
  .container { 
    .content {
      .backmatter {
        font-size: 1.25rem;
        margin-top: 3rem;
        h2 {
          font-size: 1.25em;
          margin: 1.6em 0 1em;
        }
      }
      .footnotes {
        font-size:1.125rem;

        .footnotes-list {
          .footnote-item {
            max-width: 68ch;
          }
        }
      }
    }
  }
}

.about-logo {
  height: auto;
  margin: 3rem 0 4rem;
  max-width: 100%;
}

/*========================================================================
 * END of Page customizations
 =======================================================================*/

/*------------------------------------------------------------------------
 * Experimental Figure customizations
 *------------------------------------------------------------------------
 * Problem: Images of different aspect ratios look bad in figure groups.
 *          Tall images in half columns often look too large as well.
 * Solution: Try to use container inline-size and/or block-size to limit
 *           maximum width and height.
 * Caveat 1: Browser support isâ€¦ good? It's technically Baseline. Last
 *           browser to add support was Firefox in 2023. Think it's safe.
 * Caveat 2: Still doesn't solve the problem for wildly different aspect
 *           ratios, or very tall images. But that's maybe not solvable.
 -----------------------------------------------------------------------*/
// Use only on screen for now. Can mess with print later
@media screen {
  .q-figure--group .q-figure--image {
    container: figgroup / inline-size;

    img.q-figure__image {
      max-height: 100cqi;
      max-width: 100%; // equivalent to cqi but better for backward compat.
      width: auto;
    }
  }

  .content > .q-figure.q-figure--image {
    container: figure / inline-size;

    img.q-figure__image {
      max-height: 100cqi;
      max-width: 100%; // equivalent to cqi but better for backward compat.
      width: auto;
    }
  }
}

/*========================================================================
 * END of Figure customizations
 =======================================================================*/


/*------------------------------------------------------------------------
 * Contributors page
 -----------------------------------------------------------------------*/
// Brute force solution.
.quire-contributors-list.bio {
  #christoph-heinrich {
    display: none;
  }
}
/*========================================================================
 * END of Contributors page
 =======================================================================*/


@media print {
  .dam-force-break {
    break-before: always;
  }
  .force-column-break {
    break-before: column;
  }
  .avoid-column-break {
    break-inside:avoid-column;
  }
  .never-balance-columns {
    column-fill: auto !important;
    break-inside: avoid;

    &.well-maybe-sometimes {
      break-inside:auto;
    }
  }

  .title-page {
    .title {
      .pdf-title-page-subtitle {
        display: block;
        font-size: .75em;
      }
    }
  }

  /* Attempt to fix columns on final page of section */
  .quire-page__content {
    .quire-essay &, .quire-entry &, .quire-splash & {
      // Quire's default use of balance seems fundamentally wrong.
      column-fill: auto;
    }
  }

  /* Attempt to Fix top alignment of figures */
  .q-figure:not(.q-figure--group__item) {
    padding-top: 0;
  }

  #rosoff-fig-12 {
    column-span: all;
  }

  .q-figure--group:has(#pillsbury-fig-17) {
    margin: 0 !important;
  }

  #pillsbury-fig-19 {
    margin:0 !important;
  }

  .pillsbury-fig-clear {
    margin:-.5em 0;
  }

  #page-pillsbury-fn51 {
    break-inside: avoid-page;
  }

  .bergh-header-1 {
    column-span: all;
  }

  #bergh-fig-1 {
    margin-bottom: .8125em !important;
  }

  #bergh-fig-5 {
    column-span: all;
  }

  .q-figure--group:has(#bergh-fig-6) {
    margin-bottom: 11em;
  }

  .q-figure--group:has(#bergh-fig-8) {
    margin-bottom: 0 !important;
  }

  #bergh-header-2 {
    padding-top: .5625em !important;
  }
  #bergh-fig-17 {
    margin-bottom: 0 !important;
  }

  #pope-fig-4 {
    margin-bottom: 0 !important;
    padding-bottom: 0 !important;
  }
  .q-figure--group:has(#pope-fig-16) {
    margin-bottom: 1em !important;
  }
  .q-figure--group:has(#pope-fig-19) {
    margin-bottom: 1em !important;
  }

  #robb-fig-2 {
    margin-top: 3em;
  }

  #lyall-fig-1 {
    margin-bottom: 0 !important;
    padding-bottom: 0 !important;
  }
  #lyall-fig-9 {
    margin-bottom: 1.5em;
  }
  #lyall-fig-12 {
    margin-bottom: 1.25em;
  }
  #lyall-fig-13 {
    margin-bottom: 2.875em;
  }
  #lyall-fig-14 {
    margin-bottom: 1.25em;
  }
  p:has(+ #lyall-fig-15) {
    margin-bottom: 0;
  }

  #driggers-fig-4 img {
    height: 85vh;
  }
  #driggers-fig-6 {
    margin-top:0;
  }

  .quire-page__content.appendix-page {
    column-fill: auto !important;
  }
  .appendix-header {
    break-before: page;
  }
  .colspan {
    &#miller-fig-1 {
      column-span:all !important;
      img {
        height: 85vh;
        width: auto;
      }
    }
    &#miller-fig-2 {
      column-span: all;
      img {
        height: 85vh;
        width: auto;
      }
    }
    &#miller-fig-3 {
      column-span: all;
      img {
        height: 85vh;
        width: auto;
      }
    }
    &#miller-fig-4 {
      column-span: all;
      img {
        height: 85vh;
        width: auto;
      }
    }
    &#miller-fig-5 {
      column-span: all;
    }
    &#miller-fig-6 {
      column-span: all;
    }
    &#miller-fig-7 {
      column-span: all;
    }
  }

  /* Table of Contents
  ************************************************************************/
  @page toc {
    @bottom-left {
      content: none;
    }

    @bottom-right {
      content: none;
    }
  }
  .quire-page {
    h1, h2, h3 {
      color: $main-aqua;
    }
  }
  .quire-page.quire-splash {
    .quire-page__header {
      .hero-body {
        .quire-page__header__title {
          color: $main-aqua;
        }
      }
    }
  }
  /* Page numbering fix so we can insert blank color pages without
  ** breaking ToC, AND so we can have differently numbered frontmatter
  ** This is a brute-force solution to the problem of Prince (and probably
  ** everything else) collapsing adjacent page breaks when those page
  ** breaks are created using break-before or break-after.
  **
  ** I get why the spec works this way, but it really causes some
  ** headaches. The only real way to fix it would be to create a blank
  ** content element before the header of every essay and
  ** break-before: left on that element. That would require editing
  ** templates and potentially messing with online and ePub styles.
  ** A project for the next publication perhaps.
  ************************************************************************/
  // Front matter
  .print-foreword-page {
    counter-reset: page 7;
  }
  // Brute-force page renumbering so I can insert blank pages manually later
  .print-first-page {
    counter-reset: page 1;
  }
  .essay-rosoff {
    counter-reset: page 17;
  }
  .essay-hoobler {
    counter-reset: page 51;
  }
  .essay-bergh {
    counter-reset: page 67;
  }
  .essay-pope {
    counter-reset: page 85;
  }
  .essay-robb {
    counter-reset: page 103;
  }
  .essay-lyall {
    counter-reset: page 131;
  }
  .essay-driggers {
    counter-reset: page 147;
  }

  .quire-page.quire-contents {
    $counter-margin: 36pt;
    page: toc;
    counter-reset: page -5;

    .quire-page__header.hero {
      margin:0;

      .hero-body {
        margin:0;

        .quire-page__header__title {
          color: $main-aqua;
          margin:0 calc(#{$counter-margin} + 21pt) .5em 0;
          text-align: right;
          text-transform: uppercase;
        }
      }
    }

    .section.quire-page__content {
      margin:0;
      .container {
        display: flex;
        flex-flow: row-reverse nowrap;
        margin:0;
        padding:0;
        max-width: none;

        .quire-contents-list.list {
          margin:0;

          .table-of-contents  {
            margin:0;
            .table-of-contents-list {
              margin:0;

              .section-item, .page-item {
                margin: 0 0 1.325em 0;
                padding-right: $counter-margin;
                text-align: right;

                & > a {
                  position: relative;

                  .contents-page-title {
                    color: $main-aqua;
                    display: inline;
                  }
                  .contributor {
                    display: inline-block;
                    &::before {
                      content: ' | ';
                      margin: 0 .25em;
                    }
                  }

                  &::after {
                    position: absolute;
                    bottom: 0;
                    right: calc(0 - #{$counter-margin});
                    content: target-counter(attr(href, url), page);
                    margin:0 0 0 $counter-margin;
                    text-align: right;
                    width: 21pt;
                  }
                }

                &:first-child {
                  & > a::after {
                    content: target-counter(attr(href, url), page, lower-roman); 
                    font-style: italic;
                  }
                }
                
              }
            }
          }
        }
      }
    }
  }

  #cheinrich {
    color:transparent;
    .quire-contributor__name, .quire-contributor__title,
    .quire-contributor__affiliation {
      color: $print-text-color;
      display:block !important;
      margin: -1.4em 0 0;
    }
  }

  .q-figure.q-figure--group {
    column-span: all;
  }

  section.footnotes.littlefoot--print {
    break-after: page;

    li.footnote-item.littlefoot--print p {
      break-inside: avoid;
      orphans: 4;
      widows: 4;
    }
  }
  .quire-essay {
    .quire-page__header {
      &.hero {
        break-before: right;
        background: transparent;
        text-shadow: none;

        .hero-body {
          color: $print-text-color;
          .quire-page__header__title {
            color: $main-aqua;
          }
        }
      }
    }
    &.break-left {
      .quire-page__header {
        &.hero {
          break-before: left;
        }
      }
    }
  }

  .q-figure__label {
    line-height:1.7;
    height:auto; // Why was this set to 0? What purpose could that possibly serve?

   .q-figure__caption a {
      line-height: 1.7; // why was this set to 0?
      position: unset;
    }
  }
  .about-logo {
    column-span: all;
    max-width: 100% !important;
    height: auto;
    svg {
      max-width: 100%;
      height:auto;
    }
  }

  /* back pocket for worst-case scenario
  @page:nth(32) {
    background-color: $main-aqua;
  }
  */
}
